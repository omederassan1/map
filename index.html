<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ØªØªØ¨Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background-color: #f4f4f4;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #map {
      flex: 1;
      width: 100%;
    }

    #controls {
      background-color: #fff;
      padding: 15px 10px;
      text-align: center;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
      position: fixed;
      bottom: 0;
      width: 100%;
      z-index: 1000;
    }

    select, button {
      padding: 12px 18px;
      margin: 5px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 18px;
      max-width: 100%;
    }

    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #0056b3;
    }

    #lastUpdate {
      margin-top: 10px;
      font-size: 16px;
      color: #555;
    }

    label {
      font-size: 16px;
      margin: 5px;
      display: inline-block;
    }

    .client-label {
      font-size: 14px;
      font-weight: bold;
      background: rgba(252, 251, 251, 0.8);
      color: #0a0a0a;
      padding: 2px 6px;
      border-radius: 6px;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="controls">
  <label>Ø§Ù„ÙŠÙˆÙ…:</label>
  <select id="daySelect">
    <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
    <option value="yesterday">Ø£Ù…Ø³</option>
  </select>

  <button onclick="loadData()">Ø¹Ø±Ø¶ Ø§Ù„ØªØ­Ø±ÙƒØ§Øª</button>
  <div id="lastUpdate"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // Ù†ÙØ³ Ø±ÙˆØ§Ø¨Ø· API Ø§Ù„ØªÙŠ Ø£Ø±Ø³Ù„ØªÙ‡Ø§
  const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbwssFN4J6-TSu_xnqAaeZawn1aRgAQfzgJfDTkSitBQINb4_yGBzcm91gcPmJ0wxe4plA/exec";
  const CLIENTS_API_URL = "https://script.google.com/macros/s/AKfycbxLHzKKxHx2UMK5ZpYrKLHvBOhB1hNN_ZsIvBKZ4D6wtheUpkjyJoZpreMsoX6hMlPcbA/exec";

  const map = L.map('map').setView([36.1876, 44.0205], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  let allData = {};
  let clientMarkers = [];

  // Ø£Ù„ÙˆØ§Ù† Ø«Ø§Ø¨ØªØ© Ù„ÙƒÙ„ Ù…Ù†Ø¯ÙˆØ¨ Ø¹Ø¨Ø± Ø¬Ù„Ø³Ø© Ø§Ù„ØµÙØ­Ø©
  const palette = ["#e6194b","#3cb44b","#0082c8","#f58231","#911eb4","#46f0f0","#f032e6","#d2f53c","#fabebe","#008080","#e6beff","#aa6e28","#fffac8","#800000","#aaffc3","#808000","#ffd8b1","#000080","#808080","#000000"];
  const deviceColors = {};
  let paletteIdx = 0;
  function colorFor(device){
    if(!deviceColors[device]){
      deviceColors[device] = palette[paletteIdx % palette.length];
      paletteIdx++;
    }
    return deviceColors[device];
  }

  function loadData() {
    fetch(SHEET_API_URL)
      .then(res => res.json())
      .then(data => {
        allData = data;
        processAndDisplayData();
        updateLastUpdated();
      })
      .catch(console.error);
  }

  function processAndDisplayData() {
    // Ø§Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø§Ø±ÙƒØ±Ø²/Ø§Ù„Ø®Ø·ÙˆØ·/Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± (ÙˆØ§ØªØ±Ùƒ Ø·Ø¨Ù‚Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©)
    map.eachLayer(layer => {
      if (layer instanceof L.Marker || layer instanceof L.Polyline || layer instanceof L.Circle) {
        map.removeLayer(layer);
      }
    });

    const dayFilter = document.getElementById("daySelect").value;
    const now = new Date();
    const todayStr = now.toISOString().split('T')[0];
    const yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = yesterday.toISOString().split('T')[0];

    let globalBounds = null;

    // Ù…Ø±Ù‘ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†
    for (const device in allData) {
      let positions = allData[device] || [];
      positions = positions.map(p => {
        const date = new Date(p.timestamp);
        return {
          ...p,
          timestamp: date,
          dateStr: date.toISOString().split('T')[0],
          timeStr: date.toTimeString().split(' ')[0]
        };
      }).filter(p => (dayFilter === 'today' ? p.dateStr === todayStr : p.dateStr === yesterdayStr));

      if (positions.length === 0) continue;

      // Ø§Ø±Ø³Ù… Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø¨Ù„ÙˆÙ† Ù…Ù…ÙŠØ²
      const path = positions.map(p => [p.lat, p.lon]);
      const color = colorFor(device);
      const polyline = L.polyline(path, { color }).addTo(map);

      if (!globalBounds) {
        globalBounds = polyline.getBounds();
      } else {
        globalBounds.extend(polyline.getBounds());
      }

      // Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
      L.marker([positions[0].lat, positions[0].lon], {
        icon: L.icon({
          iconUrl: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
          iconSize: [32, 32],
          iconAnchor: [16, 32]
        })
      }).addTo(map).bindPopup(`ğŸš€ ${device} - Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø±ÙƒØ©: ${positions[0].timeStr}`);

      // Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© + Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨
      const last = positions[positions.length - 1];
      const endMarker = L.marker([last.lat, last.lon], {
        icon: L.icon({
          iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
          iconSize: [60, 60],
          iconAnchor: [24, 60]
        })
      }).addTo(map).bindPopup(`ğŸ”´ ${device} - Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø±ÙƒØ©: ${last.timeStr}`);
      endMarker.bindTooltip(`${device} â€¢ ${last.timeStr}`, {
        permanent: true,
        direction: 'top',
        offset: [0, -12],
        className: 'client-label'
      });

      // Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø¯Ù…Ø¬ Ø§Ù„ØªÙˆÙ‚ÙØ§Øª ÙˆØ§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹Ø§Øª ÙƒÙ…Ø§ ÙÙŠ ÙƒÙˆØ¯Ùƒ
      const mergedStops = [];
      let group = [];

      for (let i = 0; i < positions.length; i++) {
        const p = positions[i];
        if (group.length === 0) {
          group.push(p);
        } else {
          const lastInGroup = group[group.length - 1];
          const dist = getDistance(lastInGroup.lat, lastInGroup.lon, p.lat, p.lon);

          if (dist <= 200) {
            group.push(p);
          } else {
            if (group.length > 1) mergedStops.push(group);

            const prev = positions[i - 1];
            const timeDiff = (p.timestamp - prev.timestamp) / 60000;

            if (timeDiff > 15) {
              L.marker([p.lat, p.lon], {
                icon: L.icon({
                  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-grey.png',
                  iconSize: [32, 32],
                  iconAnchor: [16, 32]
                })
              }).addTo(map).bindPopup(`ğŸ“¡ ${device} - Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${timeDiff.toFixed(0)} Ø¯Ù‚ÙŠÙ‚Ø©<br>Ø§Ù„ÙˆÙ‚Øª: ${p.timeStr}`);
            } else {
              L.marker([p.lat, p.lon], {
                icon: L.icon({
                  iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                  iconSize: [16, 16],
                  iconAnchor: [8, 16]
                })
              }).addTo(map).bindPopup(`${device} - Ø§Ù„ÙˆÙ‚Øª: ${p.timeStr}`);
            }

            group = [p];
          }
        }
      }
      if (group.length > 1) mergedStops.push(group);

      // Ø¯Ù…Ø¬ Ø§Ù„ØªÙˆÙ‚ÙØ§Øª Ø§Ù„Ù…ØªÙ‚Ø§Ø±Ø¨Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…ÙˆÙ‚Ø¹
      const finalStops = [];
      mergedStops.forEach(stopGroup => {
        const first = stopGroup[0];
        const last = stopGroup[stopGroup.length - 1];
        const durationMin = Math.round((last.timestamp - first.timestamp) / 60000);

        if (durationMin > 1) {
          let merged = false;
          for (let f of finalStops) {
            const dist = getDistance(f.lat, f.lon, first.lat, first.lon);
            if (dist <= 200) {
              f.details.push({
                from: first.timeStr,
                to: last.timeStr,
                duration: durationMin
              });
              f.totalDuration += durationMin;
              merged = true;
              break;
            }
          }

          if (!merged) {
            finalStops.push({
              lat: first.lat,
              lon: first.lon,
              details: [{
                from: first.timeStr,
                to: last.timeStr,
                duration: durationMin
              }],
              totalDuration: durationMin
            });
          }
        }
      });

      // Ø¹Ø±Ø¶ Ø§Ù„ØªÙˆÙ‚ÙØ§Øª Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© (Ø£Ø­Ù…Ø± Ù„Ù„ØªÙˆÙ‚Ù Ø§Ù„Ø·ÙˆÙŠÙ„ ÙˆØ£Ø®Ø¶Ø± Ù„Ù„Ù‚ØµÙŠØ±)
      finalStops.forEach(stop => {
        const isLongStop = stop.totalDuration > 60;
        const radius = Math.min(stop.totalDuration * 5, 1000);

        let popupContent = `<b>ğŸ“ ${device} - ØªÙˆÙ‚Ù Ø¹Ù†Ø¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</b><br>Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${stop.totalDuration} Ø¯Ù‚ÙŠÙ‚Ø©<br><hr>`;
        stop.details.forEach((d, i) => {
          popupContent += `ğŸ•’ ØªÙˆÙ‚Ù ${i+1}: ${d.from} â†’ ${d.to} (${d.duration} Ø¯Ù‚ÙŠÙ‚Ø©)<br>`;
        });

        L.circle([stop.lat, stop.lon], {
          radius,
          color: isLongStop ? 'red' : 'green',
          fillColor: isLongStop ? '#f00' : '#0f0',
          fillOpacity: 0.4
        }).addTo(map).bindPopup(popupContent);
      });
    }

    if (globalBounds) {
      map.fitBounds(globalBounds, { padding: [30, 30] });
    }

    loadClients();
  }

  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const Ï†1 = lat1 * Math.PI / 180;
    const Ï†2 = lat2 * Math.PI / 180;
    const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
    const Î”Î» = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(Î”Ï† / 2) ** 2 +
              Math.cos(Ï†1) * Math.cos(Ï†2) *
              Math.sin(Î”Î» / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function updateLastUpdated() {
    const el = document.getElementById("lastUpdate");
    const now = new Date();
    el.textContent = "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: " + now.toLocaleTimeString('ar-EG');
  }

  function loadClients() {
    fetch(CLIENTS_API_URL)
      .then(res => res.json())
      .then(data => {
        if (data.clients && Array.isArray(data.clients)) {
          clientMarkers = data.clients.map(client => {
            const marker = L.marker([client.lat, client.lon], {
              icon: L.icon({
                iconUrl: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png',
                iconSize: [16, 16],
                iconAnchor: [8, 16]
              })
            }).addTo(map);

            const tooltip = L.tooltip({
              permanent: true,
              direction: 'top',
              offset: [0, -10],
              className: 'client-label'
            })
            .setContent(`ğŸ“ ${client.name}`)
            .setLatLng([client.lat, client.lon]);

            marker.bindTooltip(tooltip);
            return { marker, tooltip };
          });

          toggleClientTooltips();
        }
      })
      .catch(console.error);
  }

  function toggleClientTooltips() {
    const currentZoom = map.getZoom();
    const show = currentZoom >= 14;

    clientMarkers.forEach(obj => {
      const tooltipElement = obj.tooltip.getElement();
      if (tooltipElement) {
        tooltipElement.style.display = show ? 'block' : 'none';
      }
    });
  }

  map.on('zoomend', toggleClientTooltips);

  // ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ Ø«Ù… ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
  loadClients();
  loadData();
  setInterval(() => { loadData(); }, 300000);
</script>

</body>
</html>
