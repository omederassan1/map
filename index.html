<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>تتبع المندوب</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background-color: #f4f4f4;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #map {
      flex: 1;
      width: 100%;
    }

    #controls {
      background-color: #fff;
      padding: 15px 10px;
      text-align: center;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
      position: fixed;
      bottom: 0;
      width: 100%;
      z-index: 1000;
    }

    select, button {
      padding: 12px 18px;
      margin: 5px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 18px;
      max-width: 100%;
    }

    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #0056b3;
    }

    #lastUpdate {
      margin-top: 10px;
      font-size: 16px;
      color: #555;
    }

    label {
      font-size: 16px;
      margin: 5px;
      display: inline-block;
    }

    .client-label {
      font-size: 14px;
      font-weight: bold;
      background: rgba(252, 251, 251, 0.8);
      color: #0a0a0a;
      padding: 2px 6px;
      border-radius: 6px;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="controls">
  <label>اليوم:</label>
  <select id="daySelect">
    <option value="today">اليوم</option>
    <option value="yesterday">أمس</option>
  </select>

  <button onclick="loadData()">عرض التحركات</button>
  <div id="lastUpdate"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // نفس روابط API التي أرسلتها
  const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbwssFN4J6-TSu_xnqAaeZawn1aRgAQfzgJfDTkSitBQINb4_yGBzcm91gcPmJ0wxe4plA/exec";
  const CLIENTS_API_URL = "https://script.google.com/macros/s/AKfycbxLHzKKxHx2UMK5ZpYrKLHvBOhB1hNN_ZsIvBKZ4D6wtheUpkjyJoZpreMsoX6hMlPcbA/exec";

  const map = L.map('map').setView([36.1876, 44.0205], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  let allData = {};
  let clientMarkers = [];

  // ألوان ثابتة لكل مندوب عبر جلسة الصفحة
  const palette = ["#e6194b","#3cb44b","#0082c8","#f58231","#911eb4","#46f0f0","#f032e6","#d2f53c","#fabebe","#008080","#e6beff","#aa6e28","#fffac8","#800000","#aaffc3","#808000","#ffd8b1","#000080","#808080","#000000"];
  const deviceColors = {};
  let paletteIdx = 0;
  function colorFor(device){
    if(!deviceColors[device]){
      deviceColors[device] = palette[paletteIdx % palette.length];
      paletteIdx++;
    }
    return deviceColors[device];
  }

  function loadData() {
    fetch(SHEET_API_URL)
      .then(res => res.json())
      .then(data => {
        allData = data;
        processAndDisplayData();
        updateLastUpdated();
      })
      .catch(console.error);
  }

  function processAndDisplayData() {
    // امسح كل الماركرز/الخطوط/الدوائر (واترك طبقة الخريطة)
    map.eachLayer(layer => {
      if (layer instanceof L.Marker || layer instanceof L.Polyline || layer instanceof L.Circle) {
        map.removeLayer(layer);
      }
    });

    const dayFilter = document.getElementById("daySelect").value;
    const now = new Date();
    const todayStr = now.toISOString().split('T')[0];
    const yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = yesterday.toISOString().split('T')[0];

    let globalBounds = null;

    // مرّ على كل المندوبين
    for (const device in allData) {
      let positions = allData[device] || [];
      positions = positions.map(p => {
        const date = new Date(p.timestamp);
        return {
          ...p,
          timestamp: date,
          dateStr: date.toISOString().split('T')[0],
          timeStr: date.toTimeString().split(' ')[0]
        };
      }).filter(p => (dayFilter === 'today' ? p.dateStr === todayStr : p.dateStr === yesterdayStr));

      if (positions.length === 0) continue;

      // ارسم مسار المندوب بلون مميز
      const path = positions.map(p => [p.lat, p.lon]);
      const color = colorFor(device);
      const polyline = L.polyline(path, { color }).addTo(map);

      if (!globalBounds) {
        globalBounds = polyline.getBounds();
      } else {
        globalBounds.extend(polyline.getBounds());
      }

      // علامة البداية
      L.marker([positions[0].lat, positions[0].lon], {
        icon: L.icon({
          iconUrl: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
          iconSize: [32, 32],
          iconAnchor: [16, 32]
        })
      }).addTo(map).bindPopup(`🚀 ${device} - بداية الحركة: ${positions[0].timeStr}`);

      // علامة النهاية + اسم المندوب
      const last = positions[positions.length - 1];
      const endMarker = L.marker([last.lat, last.lon], {
        icon: L.icon({
          iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
          iconSize: [60, 60],
          iconAnchor: [24, 60]
        })
      }).addTo(map).bindPopup(`🔴 ${device} - نهاية الحركة: ${last.timeStr}`);
      endMarker.bindTooltip(`${device} • ${last.timeStr}`, {
        permanent: true,
        direction: 'top',
        offset: [0, -12],
        className: 'client-label'
      });

      // نفس منطق دمج التوقفات والانقطاعات كما في كودك
      const mergedStops = [];
      let group = [];

      for (let i = 0; i < positions.length; i++) {
        const p = positions[i];
        if (group.length === 0) {
          group.push(p);
        } else {
          const lastInGroup = group[group.length - 1];
          const dist = getDistance(lastInGroup.lat, lastInGroup.lon, p.lat, p.lon);

          if (dist <= 200) {
            group.push(p);
          } else {
            if (group.length > 1) mergedStops.push(group);

            const prev = positions[i - 1];
            const timeDiff = (p.timestamp - prev.timestamp) / 60000;

            if (timeDiff > 15) {
              L.marker([p.lat, p.lon], {
                icon: L.icon({
                  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-grey.png',
                  iconSize: [32, 32],
                  iconAnchor: [16, 32]
                })
              }).addTo(map).bindPopup(`📡 ${device} - انقطاع الإرسال: ${timeDiff.toFixed(0)} دقيقة<br>الوقت: ${p.timeStr}`);
            } else {
              L.marker([p.lat, p.lon], {
                icon: L.icon({
                  iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                  iconSize: [16, 16],
                  iconAnchor: [8, 16]
                })
              }).addTo(map).bindPopup(`${device} - الوقت: ${p.timeStr}`);
            }

            group = [p];
          }
        }
      }
      if (group.length > 1) mergedStops.push(group);

      // دمج التوقفات المتقاربة في نفس الموقع
      const finalStops = [];
      mergedStops.forEach(stopGroup => {
        const first = stopGroup[0];
        const last = stopGroup[stopGroup.length - 1];
        const durationMin = Math.round((last.timestamp - first.timestamp) / 60000);

        if (durationMin > 1) {
          let merged = false;
          for (let f of finalStops) {
            const dist = getDistance(f.lat, f.lon, first.lat, first.lon);
            if (dist <= 200) {
              f.details.push({
                from: first.timeStr,
                to: last.timeStr,
                duration: durationMin
              });
              f.totalDuration += durationMin;
              merged = true;
              break;
            }
          }

          if (!merged) {
            finalStops.push({
              lat: first.lat,
              lon: first.lon,
              details: [{
                from: first.timeStr,
                to: last.timeStr,
                duration: durationMin
              }],
              totalDuration: durationMin
            });
          }
        }
      });

      // عرض التوقفات المدمجة (أحمر للتوقف الطويل وأخضر للقصير)
      finalStops.forEach(stop => {
        const isLongStop = stop.totalDuration > 60;
        const radius = Math.min(stop.totalDuration * 5, 1000);

        let popupContent = `<b>📍 ${device} - توقف عند الموقع</b><br>إجمالي: ${stop.totalDuration} دقيقة<br><hr>`;
        stop.details.forEach((d, i) => {
          popupContent += `🕒 توقف ${i+1}: ${d.from} → ${d.to} (${d.duration} دقيقة)<br>`;
        });

        L.circle([stop.lat, stop.lon], {
          radius,
          color: isLongStop ? 'red' : 'green',
          fillColor: isLongStop ? '#f00' : '#0f0',
          fillOpacity: 0.4
        }).addTo(map).bindPopup(popupContent);
      });
    }

    if (globalBounds) {
      map.fitBounds(globalBounds, { padding: [30, 30] });
    }

    loadClients();
  }

  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const φ1 = lat1 * Math.PI / 180;
    const φ2 = lat2 * Math.PI / 180;
    const Δφ = (lat2 - lat1) * Math.PI / 180;
    const Δλ = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(Δφ / 2) ** 2 +
              Math.cos(φ1) * Math.cos(φ2) *
              Math.sin(Δλ / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function updateLastUpdated() {
    const el = document.getElementById("lastUpdate");
    const now = new Date();
    el.textContent = "آخر تحديث: " + now.toLocaleTimeString('ar-EG');
  }

  function loadClients() {
    fetch(CLIENTS_API_URL)
      .then(res => res.json())
      .then(data => {
        if (data.clients && Array.isArray(data.clients)) {
          clientMarkers = data.clients.map(client => {
            const marker = L.marker([client.lat, client.lon], {
              icon: L.icon({
                iconUrl: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png',
                iconSize: [16, 16],
                iconAnchor: [8, 16]
              })
            }).addTo(map);

            const tooltip = L.tooltip({
              permanent: true,
              direction: 'top',
              offset: [0, -10],
              className: 'client-label'
            })
            .setContent(`📍 ${client.name}`)
            .setLatLng([client.lat, client.lon]);

            marker.bindTooltip(tooltip);
            return { marker, tooltip };
          });

          toggleClientTooltips();
        }
      })
      .catch(console.error);
  }

  function toggleClientTooltips() {
    const currentZoom = map.getZoom();
    const show = currentZoom >= 14;

    clientMarkers.forEach(obj => {
      const tooltipElement = obj.tooltip.getElement();
      if (tooltipElement) {
        tooltipElement.style.display = show ? 'block' : 'none';
      }
    });
  }

  map.on('zoomend', toggleClientTooltips);

  // تحميل أولي ثم تحديث كل 5 دقائق
  loadClients();
  loadData();
  setInterval(() => { loadData(); }, 300000);
</script>

</body>
</html>
