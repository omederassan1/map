<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ØªØªØ¨Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background-color: #f4f4f4;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #map {
      flex: 1;
      width: 100%;
    }

    #controls {
      background-color: #fff;
      padding: 15px 10px;
      text-align: center;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
      position: fixed;
      bottom: 0;
      width: 100%;
      z-index: 1000;
    }

    select, button {
      padding: 12px 18px;
      margin: 5px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 18px;
      max-width: 100%;
    }

    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #0056b3;
    }

    #lastUpdate {
      margin-top: 10px;
      font-size: 16px;
      color: #555;
    }

    label {
      font-size: 16px;
      margin: 5px;
      display: inline-block;
    }

    .client-label {
      font-size: 14px;
      font-weight: bold;
      background: rgba(252, 251, 251, 0.8);
      color: #0a0a0a;
      padding: 2px 6px;
      border-radius: 6px;
    }

    /* Ø´Ø±ÙŠØ· Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ø¹Ù„ÙŠØ§ */
    #batteryBar {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1200;
      background: rgba(255,255,255,0.95);
      padding: 8px 12px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.18);
      font-weight: 600;
      display: none;
      direction: rtl;
      font-size: 15px;
    }

    /* Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨ÙˆØ¨ Ø£Ø¨ (Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… fallback) */
    .copy-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .copy-btn:hover { background: #0056b3; }

  </style>
</head>
<body>

<div id="batteryBar"></div>
<div id="map"></div>

<div id="controls">
  <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</label>
  <select id="deviceSelect"></select>

  <label>Ø§Ù„ÙŠÙˆÙ…:</label>
  <select id="daySelect"></select>

  <button onclick="loadData()">Ø¹Ø±Ø¶ Ø§Ù„ØªØ­Ø±ÙƒØ§Øª</button>
  <div id="lastUpdate"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbz_ZY0VOSuwEA3w37tQ3J0_JrefxBo4c94Sw1lwkOXhXk3RLCCGOnIRwxrKclQSk6BZDA/exec";
  const CLIENTS_API_URL = "https://script.google.com/macros/s/AKfycbxLHzKKxHx2UMK5ZpYrKLHvBOhB1hNN_ZsIvBKZ4D6wtheUpkjyJoZpreMsoX6hMlPcbA/exec";

  const map = L.map('map').setView([36.1876, 44.0205], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  let allData = {};       // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø© Ù…Ù† Google Sheet
  let clientMarkers = []; // Ø¹Ù…Ù„Ø§Ø¡ Ù…Ù† CLIENTS_API_URL

  // --- Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ù…Ù† Ø³Ø¬Ù„ (Ù…Ø±Ù†Ø© Ù„Ø¹Ø¯Ø© Ø£Ø³Ù…Ø§Ø¡ Ù„Ù„Ø¹Ù…ÙˆØ¯) ---
  function getBatteryFromRecord(rec) {
    if (!rec) return null;

    // Ù„Ùˆ ÙƒØ§Ù† Ù…ØµÙÙˆÙØ© (rows as arrays)
    if (Array.isArray(rec)) {
      if (rec.length >= 7 && rec[6] !== undefined && rec[6] !== null && String(rec[6]).trim() !== '') return rec[6];
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ÙŠØ¬Ø§Ø¯ Ø£ÙˆÙ„ Ù‚ÙŠÙ…Ø© ØªØ¨Ø¯Ùˆ ÙƒÙ†Ø³Ø¨Ø©
      for (const v of rec) {
        if (v !== undefined && v !== null && String(v).trim().match(/\d{1,3}/)) return v;
      }
      return null;
    }

    // Ù„Ùˆ ÙƒØ§Ù† ÙƒØ§Ø¦Ù†
    const candidates = ['battery','batt','battery_level','bat','batteryLevel','col7','Ø¹Ù…ÙˆØ¯7','c7','col_7','column7'];
    for (const k of candidates) {
      if (rec[k] !== undefined && rec[k] !== null && String(rec[k]).trim() !== '') return rec[k];
    }
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ù…ÙØªØ§Ø­ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø© battery Ø£Ùˆ bat Ø£Ùˆ Ø¹Ù…ÙˆØ¯7
    for (const k of Object.keys(rec)) {
      const lk = k.toLowerCase();
      if (lk.includes('battery') || lk.includes('bat') || lk.includes('Ø¹Ù…ÙˆØ¯') || lk.includes('col7') || lk === '7') {
        if (rec[k] !== undefined && rec[k] !== null && String(rec[k]).trim() !== '') return rec[k];
      }
    }
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ÙŠØ¬Ø§Ø¯ Ø£ÙŠ Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ ØªØ´Ø¨Ù‡ Ù†Ø³Ø¨Ø©
    for (const k of Object.keys(rec)) {
      const v = rec[k];
      if (typeof v === 'string' && v.trim().match(/^\d{1,3}%?$/)) return v;
      if (typeof v === 'number' && v >= 0 && v <= 100) return v;
    }
    return null;
  }

  // --- Ø´Ø±ÙŠØ· Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠ ---
  const batteryBar = document.getElementById('batteryBar');
  function showBatteryBar(text, color = '#333', tooltip = '') {
    batteryBar.innerHTML = `ğŸ”‹ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span style="color:${color}; margin-left:8px;">${text}</span>`;
    batteryBar.title = tooltip || '';
    batteryBar.style.display = 'block';
  }
  function hideBatteryBar() {
    batteryBar.style.display = 'none';
  }

  // --- ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙŠØ§Ù… (Ø§Ù„ÙŠÙˆÙ… + 6 Ø£ÙŠØ§Ù… Ø³Ø§Ø¨Ù‚Ø©) ---
  const daySelect = document.getElementById("daySelect");
  function populateDays() {
    const daysOfWeek = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"];
    const today = new Date();
    daySelect.innerHTML = "";

    for (let i = 0; i < 7; i++) {
      const d = new Date(today);
      d.setDate(today.getDate() - i);
      const value = d.toISOString().split('T')[0];
      let name;
      if (i === 0) name = "Ø§Ù„ÙŠÙˆÙ… (" + daysOfWeek[d.getDay()] + ")";
      else if (i === 1) name = "Ø£Ù…Ø³ (" + daysOfWeek[d.getDay()] + ")";
      else name = daysOfWeek[d.getDay()] + " (" + value + ")";
      const opt = document.createElement("option");
      opt.value = value;
      opt.textContent = name;
      daySelect.appendChild(opt);
    }
  }
  populateDays();

  // --- ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´ÙŠØª Ø«Ù… Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙÙŠ select ---
  function initDevices() {
    fetch(SHEET_API_URL)
      .then(res => res.json())
      .then(data => {
        allData = data || {};
        const select = document.getElementById("deviceSelect");
        select.innerHTML = '';
        const devices = Object.keys(allData);
        devices.forEach((device, idx) => {
          const option = document.createElement("option");
          option.value = device;
          option.textContent = device;
          select.appendChild(option);
        });

        // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: Ø¹Ø±Ø¶ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙˆØ±Ù‹Ø§ (Ù…Ù† Ø£Ø­Ø¯Ø« Ø³Ø¬Ù„ Ù…ÙˆØ¬ÙˆØ¯)
        select.addEventListener('change', () => {
          updateBatteryDisplay();
        });

        // Ø¥Ù† ÙˆÙØ¬Ø¯ Ø¬Ù‡Ø§Ø² ÙˆØ§Ø­Ø¯ Ø£Ùˆ Ø£ÙƒØ«Ø± Ù†Ø­Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„ ÙˆÙ†Ø¹Ø±Ø¶ Ù†Ø³Ø¨ØªÙ‡
        if (devices.length > 0) {
          select.value = devices[0];
          updateBatteryDisplay();
        }
      })
      .catch(err => {
        console.error('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ù…Ù† Ø§Ù„Ø´ÙŠØª:', err);
      });
  }

  // --- Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¢Ø®Ø± Ø³Ø¬Ù„ Ø²Ù…Ù†ÙŠØ§Ù‹ Ù…Ù† allData[device]) ---
  function updateBatteryDisplay() {
    const device = document.getElementById("deviceSelect").value;
    if (!device || !allData[device] || allData[device].length === 0) {
      hideBatteryBar();
      return;
    }

    // Ø¥ÙŠØ¬Ø§Ø¯ Ø£Ø­Ø¯Ø« Ø³Ø¬Ù„ Ø­Ø³Ø¨ timestamp
    let latestRec = null;
    let latestDate = null;
    for (const rec of allData[device]) {
      const ts = rec.timestamp || rec.time || rec.datetime || rec.date;
      const d = ts ? new Date(ts) : null;
      if (d && !isNaN(d)) {
        if (!latestDate || d > latestDate) {
          latestDate = d;
          latestRec = rec;
        }
      }
    }
    // Ø¥Ù† Ù„Ù… Ù†Ø¬Ø¯ ØªÙˆØ§Ø±ÙŠØ®ØŒ Ù†Ø£Ø®Ø° Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø£Ø®ÙŠØ± ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©
    if (!latestRec) {
      latestRec = allData[device][allData[device].length - 1];
      latestDate = latestRec && latestRec.timestamp ? new Date(latestRec.timestamp) : null;
    }

    const rawBatt = getBatteryFromRecord(latestRec);
    let display = 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ğŸ”‹';
    let color = '#666';
    let tooltip = '';

    if (rawBatt !== null && rawBatt !== undefined && String(rawBatt).trim() !== '') {
      const s = String(rawBatt).trim();
      const m = s.match(/(\d{1,3})/);
      let num = null;
      if (m) num = parseInt(m[1], 10);
      if (num !== null && !isNaN(num)) {
        display = num + '%';
        if (num > 50) color = '#28a745';
        else if (num > 20) color = '#ff8c00';
        else color = '#dc3545';
      } else {
        display = s;
      }
    }

    if (latestDate && !isNaN(latestDate)) {
      tooltip = 'Ø¢Ø®Ø± Ø¥Ø±Ø³Ø§Ù„ÙŠØ©: ' + latestDate.toLocaleString('ar-EG');
    }
    showBatteryBar(display, color, tooltip);
  }

  // --- ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ø¸Ù‡Ø§Ø± ØªØ­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø­Ø¯Ø¯ ---
  function loadData() {
    // Ù†Ø¹ÙŠØ¯ Ø¬Ù„Ø¨ Ø§Ù„Ø´ÙŠØª ÙƒÙŠ ØªØªØ­Ø¯Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙÙŠ Ø­Ø§Ù„ ØªÙ… ØªØºÙŠÙŠØ±Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙŠØª)
    fetch(SHEET_API_URL)
      .then(res => res.json())
      .then(data => {
        allData = data || {};
        processAndDisplayData();
        updateLastUpdated();
        updateBatteryDisplay(); // Ù†Ø­Ø¯Ø« Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
      })
      .catch(err => {
        console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', err);
      });
  }

  function processAndDisplayData() {
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (markers, polylines, circles)
    map.eachLayer(layer => {
      if (layer instanceof L.Marker || layer instanceof L.Polyline || layer instanceof L.Circle) {
        map.removeLayer(layer);
      }
    });

    const device = document.getElementById("deviceSelect").value;
    const dayFilter = document.getElementById("daySelect").value;

    let positions = allData[device] || [];
    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·ÙˆØ§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠØ© ÙˆØªØ´ÙƒÙŠÙ„ Ø­Ù‚ÙˆÙ„ Ù…Ø³Ø§Ø¹Ø¯Ø©
    positions = positions.map(p => {
      const date = new Date(p.timestamp);
      return {
        ...p,
        timestamp: date,
        dateStr: isNaN(date) ? (p.date ? String(p.date).split('T')[0] : '') : date.toISOString().split('T')[0],
        timeStr: isNaN(date) ? (p.time || '') : date.toTimeString().split(' ')[0]
      };
    }).filter(p => p.dateStr === dayFilter);

    if (positions.length === 0) return;

    const path = positions.map(p => [p.lat, p.lon]);
    const polyline = L.polyline(path, { color: 'blue' }).addTo(map);
    map.fitBounds(polyline.getBounds());

    // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø±ÙƒØ© (Ù†ÙØ¶ÙŠÙ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ø¥Ù† ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø£ÙˆÙ„ Ø³Ø¬Ù„)
    const first = positions[0];
    const firstBattRaw = getBatteryFromRecord(first);
    const firstBattText = firstBattRaw ? String(firstBattRaw) : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ğŸ”‹';
    L.marker([first.lat, first.lon], {
      icon: L.icon({
        iconUrl: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32]
      })
    }).addTo(map).bindPopup(`âœ… Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø±ÙƒØ©: ${first.timeStr}<br>ğŸ”‹ Ø´Ø­Ù†: <b>${firstBattText}</b>`);

    // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø±ÙƒØ© (Ù†ÙØ¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ù„Ùˆ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©)
    const lastPos = positions[positions.length - 1];
    const lastBattRaw = getBatteryFromRecord(lastPos);
    const lastBattText = lastBattRaw ? String(lastBattRaw) : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ğŸ”‹';
    L.marker([lastPos.lat, lastPos.lon], {
      icon: L.icon({
        iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
        iconSize: [60, 60],
        iconAnchor: [24, 60]
      })
    }).addTo(map).bindPopup(`ğŸ”´ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø±ÙƒØ©: ${lastPos.timeStr}<br>ğŸ”‹ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø­Ù†: <b>${lastBattText}</b>`);

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ØªÙˆÙ‚ÙØ§Øª ÙˆØ§Ø¸Ù‡Ø§Ø± Ù†Ù‚Ø§Ø· Ø§Ù„ØªÙØªÙŠØ´ Ù…Ø¹ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ù„ÙƒÙ„ Ù†Ù‚Ø·Ø© (Ù„Ùˆ Ù…ØªÙˆÙØ±Ø©)
    const mergedStops = [];
    let group = [];

    for (let i = 0; i < positions.length; i++) {
      const p = positions[i];
      if (group.length === 0) {
        group.push(p);
      } else {
        const last = group[group.length - 1];
        const dist = getDistance(last.lat, last.lon, p.lat, p.lon);

        if (dist <= 200) {
          group.push(p);
        } else {
          if (group.length > 1) mergedStops.push(group);

          const prev = positions[i - 1];
          const timeDiff = (p.timestamp - prev.timestamp) / 60000;

          const battRaw = getBatteryFromRecord(p);
          const battText = battRaw ? String(battRaw) : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ğŸ”‹';

          if (timeDiff > 15) {
            L.marker([p.lat, p.lon], {
              icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-grey.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
              })
            }).addTo(map).bindPopup(`ğŸ“¡ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${timeDiff.toFixed(0)} Ø¯Ù‚ÙŠÙ‚Ø©<br>Ø§Ù„ÙˆÙ‚Øª: ${p.timeStr}<br>ğŸ”‹ Ø´Ø­Ù†: <b>${battText}</b>`);
          } else {
            L.marker([p.lat, p.lon], {
              icon: L.icon({
                iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                iconSize: [16, 16],
                iconAnchor: [8, 16]
              })
            }).addTo(map).bindPopup(`Ø§Ù„ÙˆÙ‚Øª: ${p.timeStr}<br>ğŸ”‹ Ø´Ø­Ù†: <b>${battText}</b>`);
          }

          group = [p];
        }
      }
    }

    if (group.length > 1) mergedStops.push(group);

    const finalStops = [];
    mergedStops.forEach(stopGroup => {
      const first = stopGroup[0];
      const last = stopGroup[stopGroup.length - 1];
      const durationMin = Math.round((last.timestamp - first.timestamp) / 60000);

      if (durationMin > 1) {
        let merged = false;
        for (let f of finalStops) {
          const dist = getDistance(f.lat, f.lon, first.lat, first.lon);
          if (dist <= 200) {
            f.details.push({
              from: first.timeStr,
              to: last.timeStr,
              duration: durationMin
            });
            f.totalDuration += durationMin;
            merged = true;
            break;
          }
        }

        if (!merged) {
          finalStops.push({
            lat: first.lat,
            lon: first.lon,
            details: [{
              from: first.timeStr,
              to: last.timeStr,
              duration: durationMin
            }],
            totalDuration: durationMin
          });
        }
      }
    });

    finalStops.forEach(stop => {
      const isLongStop = stop.totalDuration > 60;
      const radius = Math.min(stop.totalDuration * 5, 1000);

      let popupContent = `<b>ğŸ“ ØªÙˆÙ‚Ù Ø¹Ù†Ø¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</b><br>Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${stop.totalDuration} Ø¯Ù‚ÙŠÙ‚Ø©<br><hr>`;
      stop.details.forEach((d, i) => {
        popupContent += `ğŸ•’ ØªÙˆÙ‚Ù ${i+1}: ${d.from} â†’ ${d.to} (${d.duration} Ø¯Ù‚ÙŠÙ‚Ø©)<br>`;
      });

      L.circle([stop.lat, stop.lon], {
        radius,
        color: isLongStop ? 'red' : 'green',
        fillColor: isLongStop ? '#f00' : '#0f0',
        fillOpacity: 0.4
      }).addTo(map).bindPopup(popupContent);
    });

    loadClients(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¹Ù…Ù„Ø§Ø¡ (Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ±Ù‡Ù… ÙÙˆÙ‚ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª)
  }

  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const Ï†1 = lat1 * Math.PI / 180;
    const Ï†2 = lat2 * Math.PI / 180;
    const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
    const Î”Î» = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(Î”Ï† / 2) ** 2 +
              Math.cos(Ï†1) * Math.cos(Ï†2) *
              Math.sin(Î”Î» / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function updateLastUpdated() {
    const el = document.getElementById("lastUpdate");
    const now = new Date();
    el.textContent = "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: " + now.toLocaleTimeString('ar-EG');
  }

  // --- ØªØ­Ù…ÙŠÙ„ Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ¹Ø±Ø¶Ù‡Ù… + Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø¨ÙˆØ³ (Ø¥Ù† ÙˆÙØ¬Ø¯Øª) ---
  function loadClients() {
    fetch(CLIENTS_API_URL)
      .then(res => res.json())
      .then(data => {
        // Ø¥Ø²Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        clientMarkers.forEach(obj => {
          try { map.removeLayer(obj.marker); } catch(e){}
        });
        clientMarkers = [];

        if (data.clients && Array.isArray(data.clients)) {
          clientMarkers = data.clients.map(client => {
            const marker = L.marker([client.lat, client.lon], {
              icon: L.icon({
                iconUrl: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png',
                iconSize: [16, 16],
                iconAnchor: [8, 16]
              })
            }).addTo(map);

            const battery = getBatteryFromRecord(client);
            const battText = battery ? String(battery) : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ğŸ”‹';
            marker.bindPopup(`ğŸ“ ${client.name || ''}<br>ğŸ”‹ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø­Ù†: <b>${battText}</b>`);

            const tooltip = L.tooltip({
              permanent: true,
              direction: 'top',
              offset: [0, -10],
              className: 'client-label'
            })
            .setContent(`ğŸ“ ${client.name || ''}`)
            .setLatLng([client.lat, client.lon]);

            marker.bindTooltip(tooltip);
            return { marker, tooltip };
          });

          toggleClientTooltips();
        }
      })
      .catch(err => console.error('Ø®Ø·Ø£ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:', err));
  }

  function toggleClientTooltips() {
    const currentZoom = map.getZoom();
    const show = currentZoom >= 14;

    clientMarkers.forEach(obj => {
      const tooltipElement = obj.tooltip.getElement();
      if (tooltipElement) {
        tooltipElement.style.display = show ? 'block' : 'none';
      }
    });
  }

  map.on('zoomend', toggleClientTooltips);

  // ------------------------
  // Ù†Ø³Ø® Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¨Ø²Ø± Ø§Ù„ÙŠÙ…ÙŠÙ† (Ù…Ø¹ fallback)
  // ------------------------
  map.on('contextmenu', function (e) {
    const lat = e.latlng.lat.toFixed(6);
    const lon = e.latlng.lng.toFixed(6);

    const popupContent = `
      <div style="text-align:center; direction:rtl;">
        ğŸ“ <b>Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:</b><br>
        ${lat}, ${lon}<br><br>
        <button id="copyCoordsBtn" data-lat="${lat}" data-lon="${lon}" style="
          background:#007bff;
          color:white;
          border:none;
          border-radius:6px;
          padding:6px 12px;
          cursor:pointer;
        ">ğŸ“‹ Ù†Ø³Ø®</button>
      </div>
    `;

    L.popup()
      .setLatLng(e.latlng)
      .setContent(popupContent)
      .openOn(map);
  });

  // Ø§Ø³ØªÙ…Ø§Ø¹ Ù…Ø±ÙƒØ²ÙŠ Ù„Ø²Ø± Ø§Ù„Ù†Ø³Ø® (ÙŠØ¹Ù…Ù„ Ø­ØªÙ‰ Ù„Ùˆ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ù€ popup)
  document.addEventListener('click', async function(ev) {
    const target = ev.target;
    const btn = target.closest ? target.closest('#copyCoordsBtn') : (target.id === 'copyCoordsBtn' ? target : null);
    if (!btn) return;

    const lat = btn.getAttribute('data-lat');
    const lon = btn.getAttribute('data-lon');
    const coords = `${lat}, ${lon}`;

    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(coords);
      } else {
        const ta = document.createElement('textarea');
        ta.value = coords;
        ta.setAttribute('readonly', '');
        ta.style.position = 'absolute';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);

        const sel = document.getSelection();
        const prevRange = sel.rangeCount > 0 ? sel.getRangeAt(0) : null;

        ta.select();
        ta.setSelectionRange(0, ta.value.length);
        document.execCommand('copy');

        document.body.removeChild(ta);
        if (prevRange) {
          sel.removeAllRanges();
          sel.addRange(prevRange);
        }
      }

      const original = btn.innerHTML;
      btn.innerHTML = 'âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®!';
      setTimeout(() => { try { map.closePopup(); } catch(e){} }, 900);
      setTimeout(() => { try { btn.innerHTML = original; } catch(e){} }, 1200);

    } catch (err) {
      alert('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¹Ù…Ù„ Ø¹Ø¨Ø± HTTPS Ø£Ùˆ Ø¹Ù„Ù‰ localhost.\n\nØ§Ù„Ø®Ø·Ø£: ' + (err && err.message ? err.message : err));
    }
  });

  // --- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±ÙŠ ---
  initDevices();
  loadClients();

  // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚ (Ø¥Ù† ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£Ø­Ø¯Ù‡Ù…)
  setInterval(() => {
    const device = document.getElementById("deviceSelect").value;
    if (device) {
      loadData();
    }
  }, 300000);

  // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ù†Ø±ÙŠØ¯ Ø£ÙŠØ¶Ø§Ù‹ Ø£Ù† Ù†Ù…Ù„Ø£ devices Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ø¬Ø§Ù‡Ø²Ø© (initDevices ÙŠÙ‚ÙˆÙ… Ø¨Ø°Ù„Ùƒ)
  // ÙˆÙ…Ù…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¶ØºØ· "Ø¹Ø±Ø¶ Ø§Ù„ØªØ­Ø±ÙƒØ§Øª" Ù„Ø¹Ø±Ø¶ Ø®Ø· Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø­Ø¯Ø¯.

</script>

</body>
</html>
