<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ØªØªØ¨Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background-color: #f4f4f4;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #map {
      flex: 1;
      width: 100%;
    }

    #controls {
      background-color: #fff;
      padding: 15px 10px;
      text-align: center;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
      position: fixed;
      bottom: 0;
      width: 100%;
      z-index: 1000;
    }

    select, button {
      padding: 12px 18px;
      margin: 5px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 18px;
      max-width: 100%;
    }

    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #0056b3;
    }

    #lastUpdate {
      margin-top: 10px;
      font-size: 16px;
      color: #555;
    }

    label {
      font-size: 16px;
      margin: 5px;
      display: inline-block;
    }

    .client-label {
      font-size: 14px;
      font-weight: bold;
      background: rgba(255, 165, 0, 0.8);
      color: #fff;
      padding: 2px 6px;
      border-radius: 6px;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="controls">
  <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</label>
  <select id="deviceSelect"></select>

  <label>Ø§Ù„ÙŠÙˆÙ…:</label>
  <select id="daySelect">
    <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
    <option value="yesterday">Ø£Ù…Ø³</option>
  </select>

  <button onclick="loadData()">Ø¹Ø±Ø¶ Ø§Ù„ØªØ­Ø±ÙƒØ§Øª</button>
  <div id="lastUpdate"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbwssFN4J6-TSu_xnqAaeZawn1aRgAQfzgJfDTkSitBQINb4_yGBzcm91gcPmJ0wxe4plA/exec"; // â† Ø±Ø§Ø¨Ø· ØªØªØ¨Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†
  const CLIENTS_API_URL = "https://script.google.com/macros/s/AKfycbxLHzKKxHx2UMK5ZpYrKLHvBOhB1hNN_ZsIvBKZ4D6wtheUpkjyJoZpreMsoX6hMlPcbA/exec"; // â† Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡

  const map = L.map('map').setView([36.1876, 44.0205], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  let allData = {};

  function loadData() {
    fetch(SHEET_API_URL)
      .then(res => res.json())
      .then(data => {
        allData = data;
        processAndDisplayData();
        updateLastUpdated();
      });
  }

  function processAndDisplayData() {
    map.eachLayer(layer => {
      if (layer instanceof L.Marker || layer instanceof L.Polyline || layer instanceof L.Circle) {
        map.removeLayer(layer);
      }
    });

    const device = document.getElementById("deviceSelect").value;
    const dayFilter = document.getElementById("daySelect").value;
    const now = new Date();
    const todayStr = now.toISOString().split('T')[0];
    const yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = yesterday.toISOString().split('T')[0];

    let positions = allData[device] || [];
    positions = positions.map(p => {
      const date = new Date(p.timestamp);
      return {
        ...p,
        timestamp: date,
        dateStr: date.toISOString().split('T')[0],
        timeStr: date.toTimeString().split(' ')[0]
      };
    }).filter(p => (dayFilter === 'today' ? p.dateStr === todayStr : p.dateStr === yesterdayStr));

    if (positions.length === 0) return;

    const path = positions.map(p => [p.lat, p.lon]);
    const polyline = L.polyline(path, { color: 'blue' }).addTo(map);
    map.fitBounds(polyline.getBounds());

    L.marker([positions[0].lat, positions[0].lon], {
      icon: L.icon({
        iconUrl: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32]
      })
    }).addTo(map).bindPopup(`Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø±ÙƒØ©: ${positions[0].timeStr}`);

    L.marker([positions[positions.length - 1].lat, positions[positions.length - 1].lon], {
      icon: L.icon({
        iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
        iconSize: [60, 60],
        iconAnchor: [24, 60]
      })
    }).addTo(map).bindPopup(`ðŸ”´ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø±ÙƒØ©: ${positions[positions.length - 1].timeStr}`);

    const mergedStops = [];
    let group = [];

    for (let i = 0; i < positions.length; i++) {
      const p = positions[i];
      if (group.length === 0) {
        group.push(p);
      } else {
        const last = group[group.length - 1];
        const dist = getDistance(last.lat, last.lon, p.lat, p.lon);

        if (dist <= 200) {
          group.push(p);
        } else {
          if (group.length > 1) mergedStops.push(group);

          const prev = positions[i - 1];
          const timeDiff = (p.timestamp - prev.timestamp) / 60000;

          if (timeDiff > 15) {
            L.marker([p.lat, p.lon], {
              icon: L.icon({
                iconUrl: 'https://maps.google.com/mapfiles/ms/icons/black-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
              })
            }).addTo(map).bindPopup(`ðŸ“¡ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${timeDiff.toFixed(0)} Ø¯Ù‚ÙŠÙ‚Ø©<br>Ø§Ù„ÙˆÙ‚Øª: ${p.timeStr}`);
          } else {
            L.marker([p.lat, p.lon]).addTo(map).bindPopup(`Ø§Ù„ÙˆÙ‚Øª: ${p.timeStr}`);
          }

          group = [p];
        }
      }
    }

    if (group.length > 1) mergedStops.push(group);

    mergedStops.forEach(stopGroup => {
      const first = stopGroup[0];
      const last = stopGroup[stopGroup.length - 1];
      const durationMin = Math.round((last.timestamp - first.timestamp) / 60000);
      if (durationMin > 1) {
        const radius = Math.min(durationMin * 5, 1000);
        const isLongStop = durationMin > 60;
        L.circle([first.lat, first.lon], {
          radius,
          color: isLongStop ? 'red' : 'green',
          fillColor: isLongStop ? '#f00' : '#0f0',
          fillOpacity: 0.4
        }).addTo(map).bindPopup(`ØªÙˆÙ‚Ù Ù…Ù† ${first.timeStr} Ø¥Ù„Ù‰ ${last.timeStr} Ù„Ù…Ø¯Ø© ${durationMin} Ø¯Ù‚ÙŠÙ‚Ø©`);
      }
    });

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    loadClients();
  }

  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const Ï†1 = lat1 * Math.PI / 180;
    const Ï†2 = lat2 * Math.PI / 180;
    const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
    const Î”Î» = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(Î”Ï† / 2) ** 2 +
              Math.cos(Ï†1) * Math.cos(Ï†2) *
              Math.sin(Î”Î» / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function updateLastUpdated() {
    const el = document.getElementById("lastUpdate");
    const now = new Date();
    el.textContent = "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: " + now.toLocaleTimeString('ar-EG');
  }

  function loadClients() {
    fetch(CLIENTS_API_URL)
      .then(res => res.json())
      .then(data => {
        if (data.clients && Array.isArray(data.clients)) {
          data.clients.forEach(client => {
            const marker = L.marker([client.lat, client.lon], {
              icon: L.icon({
                iconUrl: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
              })
            }).addTo(map);
            marker.bindTooltip(`ðŸ“ ${client.name}`, {
  permanent: true,
  direction: 'top',
  offset: [0, -10],
  className: 'client-label'
});
          });
        }
      });
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
  fetch(SHEET_API_URL)
    .then(res => res.json())
    .then(data => {
      allData = data;
      const select = document.getElementById("deviceSelect");
      for (const device in data) {
        const option = document.createElement("option");
        option.value = device;
        option.textContent = device;
        select.appendChild(option);
      }
    });

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
  loadClients();

  // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
  setInterval(() => {
    const device = document.getElementById("deviceSelect").value;
    if (device) {
      loadData();
    }
  }, 300000);
</script>

</body>
</html>
